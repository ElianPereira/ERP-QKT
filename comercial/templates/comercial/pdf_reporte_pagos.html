{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Pagos</title>
    <style>
        @page {
            size: letter; 
            margin: 1.5cm;
            @bottom-right {
                content: "Página " counter(page) " de " counter(pages);
                font-family: sans-serif;
                font-size: 9px;
                color: #777;
            }
        }
        body { font-family: 'Helvetica', sans-serif; color: #333; font-size: 11px; }
        
        /* HEADER */
        .header { width: 100%; margin-bottom: 20px; border-bottom: 2px solid #444; padding-bottom: 10px; }
        .header td { vertical-align: middle; }
        .titulo { font-size: 18px; font-weight: bold; color: #2c3e50; text-transform: uppercase; }
        .subtitulo { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .meta-info { text-align: right; font-size: 10px; color: #555; }
        
        /* TABLA PRINCIPAL */
        .table-data { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .table-data th { 
            background-color: #2c3e50; 
            color: white; 
            font-weight: bold; 
            padding: 8px 5px; 
            text-align: left; 
            font-size: 10px;
            border-bottom: 2px solid #000;
        }
        .table-data td { 
            padding: 6px 5px; 
            border-bottom: 1px solid #ddd; 
            font-size: 10px;
            vertical-align: top;
        }
        /* Zebra Striping */
        .table-data tr:nth-child(even) { background-color: #f8f9fa; }
        
        /* Columnas específicas */
        .col-monto { text-align: right; font-weight: bold; width: 80px; }
        .col-fecha { width: 70px; }
        .col-metodo { width: 90px; }
        .col-folio { width: 60px; text-align: center; }
        .status-badge {
            display: inline-block; padding: 2px 4px; border-radius: 3px; font-size: 9px; color: #fff; background: #95a5a6;
        }

        /* RESUMEN FINAL */
        .summary-box { 
            width: 100%; 
            page-break-inside: avoid; 
            margin-top: 20px;
            border: 1px solid #ccc;
        }
        .summary-box td { vertical-align: top; padding: 15px; }
        
        .box-metodos { width: 60%; border-right: 1px solid #ccc; }
        .box-total { width: 40%; text-align: right; background-color: #f1f3f5; }
        
        .table-resumen { width: 100%; font-size: 11px; }
        .table-resumen td { padding: 4px 0; border-bottom: 1px dashed #eee; }
        
        .total-big { font-size: 24px; font-weight: bold; color: #27ae60; margin-top: 10px; }
        .total-label { font-size: 12px; text-transform: uppercase; color: #555; font-weight: bold; }

    </style>
</head>
<body>

    <table class="header">
        <tr>
            <td width="20%">
                {% if logo_url %}
                <img src="{{ logo_url }}" style="max-height: 50px;">
                {% else %}
                <b>QUINTA KO'OX TANIL</b>
                {% endif %}
            </td>
            <td width="50%">
                <div class="titulo">Reporte Detallado de Ingresos</div>
                <div class="subtitulo">
                    {% if fecha_inicio and fecha_fin %}
                        Periodo: {{ fecha_inicio }} al {{ fecha_fin }}
                    {% else %}
                        Histórico Completo
                    {% endif %}
                </div>
            </td>
            <td width="30%" class="meta-info">
                Generado: {{ generado_el|date:"d/m/Y H:i" }}<br>
                Solicitado por: {{ user.username }}
            </td>
        </tr>
    </table>

    <table class="table-data">
        <thead>
            <tr>
                <th class="col-fecha">Fecha</th>
                <th class="col-folio">Folio</th>
                <th>Cliente / Evento</th>
                <th class="col-metodo">Método</th>
                <th>Ref / Notas</th>
                <th>Staff</th>
                <th class="col-monto">Importe</th>
            </tr>
        </thead>
        <tbody>
            {% for pago in pagos %}
            <tr>
                <td>{{ pago.fecha_pago|date:"d M Y" }}</td>
                <td style="text-align: center;">
                    <span style="font-family: monospace; color:#555;">#{{ pago.cotizacion.id }}</span>
                </td>
                <td>
                    <strong>{{ pago.cotizacion.cliente.nombre }}</strong><br>
                    <span style="color:#666; font-style: italic;">{{ pago.cotizacion.nombre_evento|truncatechars:30 }}</span>
                </td>
                <td>
                    <span class="status-badge" style="background-color: #34495e;">
                        {{ pago.get_metodo_display }}
                    </span>
                </td>
                <td>
                    {% if pago.referencia %}
                        {{ pago.referencia }}
                    {% else %}
                        <span style="color:#ccc;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if pago.usuario %}
                        {{ pago.usuario.username|truncatechars:10 }}
                    {% else %}
                        <span style="color:#ccc;">Sis</span>
                    {% endif %}
                </td>
                <td class="col-monto">
                    ${{ pago.monto|intcomma }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px; color: #777;">
                    No se encontraron pagos en este periodo.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <table class="summary-box">
        <tr>
            <td class="box-metodos">
                <h4 style="margin-top:0; border-bottom:1px solid #ccc; padding-bottom:5px;">Desglose por Vía de Pago</h4>
                <table class="table-resumen">
                    {% for m in resumen_metodos %}
                    <tr>
                        <td>{{ m.nombre }}</td>
                        <td style="text-align: right; width: 40px; color:#777;">{{ m.porcentaje|floatformat:1 }}%</td>
                        <td style="text-align: right; font-weight: bold;">${{ m.total|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
            
            <td class="box-total">
                <div class="total-label">Ingresos Totales</div>
                <div class="total-big">${{ total_ingresos|intcomma }}</div>
                <br>
                <div style="font-size: 10px; color:#777;">
                    * Este reporte refleja los pagos efectivamente cobrados en el periodo seleccionado.
                </div>
            </td>
        </tr>
    </table>

</body>
</html>