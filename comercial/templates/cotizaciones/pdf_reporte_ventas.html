{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Financiero Completo</title>
    <style>
        @page { size: letter landscape; margin: 0.5cm; }
        
        body { font-family: 'Helvetica', sans-serif; color: #333; font-size: 9px; }
        
        /* ENCABEZADO */
        .header { width: 100%; border-bottom: 2px solid #356685; margin-bottom: 15px; padding-bottom: 10px; }
        .header td { vertical-align: middle; }
        .title { font-size: 18px; font-weight: bold; color: #356685; text-transform: uppercase; }
        .subtitle { font-size: 10px; color: #666; }
        
        /* TABLAS COMUNES */
        .table-common { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        
        .table-common th {
            background-color: #356685; color: white; padding: 5px 3px;
            text-align: right; font-size: 8px; font-weight: bold;
        }
        .table-common th.text-left { text-align: left; }
        .table-common th.text-center { text-align: center; }

        .table-common td {
            border-bottom: 1px solid #eee; padding: 5px 3px;
            text-align: right; font-size: 9px;
        }
        .table-common td.text-left { text-align: left; }
        .table-common td.text-center { text-align: center; }

        /* ESTILOS ESPECÍFICOS */
        .col-ganancia { background-color: #28a745; color: white; font-weight: bold; }
        .col-gasto { color: #dc3545; }
        
        /* TOTALES DE TABLA */
        .totals-row td {
            border-top: 2px solid #333; border-bottom: 2px solid #333;
            font-weight: bold; background-color: #f0f0f0; font-size: 10px;
        }

        /* SECCIONES Y CAJAS */
        .section-title {
            font-size: 12px; font-weight: bold; color: #356685; 
            margin-top: 25px; margin-bottom: 5px; border-bottom: 1px solid #ccc;
        }

        /* CAJAS INFERIORES */
        .box { 
            border: 1px solid #ccc; padding: 15px; background-color: #fcfcfc; border-radius: 5px; 
            page-break-inside: avoid;
        }
        .row-item { margin-bottom: 6px; font-size: 11px; clear: both; }
        .row-total { 
            margin-top: 8px; border-top: 1px solid #999; padding-top: 8px; 
            font-weight: bold; font-size: 13px; clear: both;
        }
        .label { float: left; }
        .value { float: right; }
        
        /* UTILIDAD FINAL */
        .final-profit-box { background-color: #e8f5e9; border: 1px solid #28a745; }
        .final-profit-value { color: #28a745; font-size: 16px; }
        .final-loss-value { color: #dc3545; font-size: 16px; }
    </style>
</head>
<body>

    <table class="header">
        <tr>
            <td style="width: 10%;">
                <img src="{{ logo_url }}" style="height: 50px;">
            </td>
            <td style="width: 60%;">
                <div class="title">Reporte de Rentabilidad Real</div>
                <div class="subtitle">Quinta Ko'ox Tanil | Eventos vs Gastos Operativos</div>
                <div class="subtitle">Generado: {% now "d/m/Y H:i" %}</div>
            </td>
            <td style="width: 30%; text-align: right;">
                <strong>Periodo:</strong> {{ fecha_inicio }} al {{ fecha_fin }}<br>
                <strong>Filtro:</strong> {{ estado_filtro }}
            </td>
        </tr>
    </table>

    <div class="section-title">1. UTILIDAD BRUTA POR EVENTOS (Ventas Directas)</div>
    <table class="table-common">
        <thead>
            <tr>
                <th class="text-left" style="width: 5%;">ID</th>
                <th class="text-left" style="width: 8%;">Fecha</th>
                <th class="text-left" style="width: 25%;">Cliente / Evento</th>
                <th class="text-center" style="width: 10%;">Estado</th>
                <th style="width: 13%;">Precio Final</th>
                <th class="col-gasto" style="width: 13%;">(-) Gasto Directo</th>
                <th class="col-ganancia" style="width: 13%;">(=) Utilidad Bruta</th>
            </tr>
        </thead>
        <tbody>
            {% for item in datos %}
            <tr>
                <td class="text-left">{{ item.folio }}</td>
                <td class="text-left">{{ item.fecha|date:"d/m/y" }}</td>
                <td class="text-left">
                    <strong>{{ item.cliente|truncatechars:25 }}</strong><br>
                    <span style="color:#666; font-size:8px;">{{ item.producto|truncatechars:30 }}</span>
                </td>
                <td class="text-center">{{ item.estado }}</td>
                
                <td>${{ item.total|floatformat:2|intcomma }}</td>
                <td class="col-gasto">-${{ item.gastos|floatformat:2|intcomma }}</td>
                <td class="col-ganancia" style="color:white;">${{ item.ganancia|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="text-center">No hay eventos que coincidan con el filtro.</td></tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="totals-row">
                <td colspan="4" class="text-center">SUBTOTAL EVENTOS</td>
                <td>${{ t_total_ventas|floatformat:2|intcomma }}</td>
                <td class="col-gasto">-${{ t_gastos_eventos|floatformat:2|intcomma }}</td>
                <td class="col-ganancia" style="color:#218838;">${{ t_ganancia_eventos|floatformat:2|intcomma }}</td>
            </tr>
        </tfoot>
    </table>

    <div class="section-title">2. GASTOS OPERATIVOS / ADMINISTRATIVOS (No asignados a eventos)</div>
    <table class="table-common" style="width: 80%;">
        <thead>
            <tr>
                <th class="text-left" style="width: 15%;">Fecha</th>
                <th class="text-left" style="width: 20%;">Categoría</th>
                <th class="text-left" style="width: 40%;">Descripción / Proveedor</th>
                <th style="width: 25%;">Monto</th>
            </tr>
        </thead>
        <tbody>
            {% for gasto in gastos_operativos_list %}
            <tr>
                <td class="text-left">{{ gasto.fecha_gasto|date:"d/m/Y" }}</td>
                <td class="text-left">{{ gasto.get_categoria_display }}</td>
                <td class="text-left">
                    {{ gasto.descripcion|truncatechars:45 }}
                    {% if gasto.proveedor %}<br><i style="color:#888;">{{ gasto.proveedor|truncatechars:35 }}</i>{% endif %}
                </td>
                <td class="col-gasto">${{ gasto.total_linea|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center">No hay gastos administrativos en este periodo.</td></tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="totals-row">
                <td colspan="3" class="text-center">TOTAL GASTOS OPERATIVOS</td>
                <td class="col-gasto">-${{ total_gastos_operativos|floatformat:2|intcomma }}</td>
            </tr>
        </tfoot>
    </table>

    <table style="width: 100%; margin-top: 30px;">
        <tr>
            <td style="width: 45%; vertical-align: top;">
                <div class="box">
                    <div style="font-weight:bold; color:#356685; margin-bottom:15px; text-transform:uppercase;">Flujo de Efectivo (Cobrado)</div>
                    <div class="row-item"><span class="label">Efectivo:</span><span class="value">${{ total_efectivo|floatformat:2|intcomma }}</span></div>
                    <div class="row-item"><span class="label">Transferencias:</span><span class="value">${{ total_transferencia|floatformat:2|intcomma }}</span></div>
                    {% if total_otros > 0 %}
                    <div class="row-item"><span class="label">Otros Métodos:</span><span class="value">${{ total_otros|floatformat:2|intcomma }}</span></div>
                    {% endif %}
                    <div class="row-total"><span class="label">TOTAL INGRESADO:</span><span class="value">${{ total_ingresado|floatformat:2|intcomma }}</span></div>
                    <div style="font-size: 9px; color: #777; margin-top: 5px;">* Pagos reales recibidos en fecha.</div>
                </div>
            </td>
            
            <td style="width: 5%;"></td>

            <td style="width: 50%; vertical-align: top;">
                <div class="box final-profit-box">
                    <div style="font-weight:bold; color:#218838; margin-bottom:15px; text-transform:uppercase; font-size: 14px;">Estado de Resultados</div>
                    
                    <div class="row-item">
                        <span class="label">Utilidad Bruta (Eventos):</span>
                        <span class="value" style="color: green; font-weight: bold;">${{ t_ganancia_eventos|floatformat:2|intcomma }}</span>
                    </div>
                    
                    <div class="row-item">
                        <span class="label">(-) Gastos Administrativos:</span>
                        <span class="value" style="color: #dc3545; font-weight: bold;">- ${{ total_gastos_operativos|floatformat:2|intcomma }}</span>
                    </div>

                    <div class="row-total" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #28a745;">
                        <span class="label" style="font-size: 14px;">UTILIDAD NETA REAL:</span>
                        <span class="value {% if utilidad_neta_real >= 0 %}final-profit-value{% else %}final-loss-value{% endif %}">
                            ${{ utilidad_neta_real|floatformat:2|intcomma }}
                        </span>
                    </div>
                </div>
            </td>
        </tr>
    </table>

</body>
</html>