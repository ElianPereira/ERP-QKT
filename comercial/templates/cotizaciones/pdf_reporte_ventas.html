{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estado De Resultados</title>
    <style>
        @page { size: legal landscape; margin: 1cm; }
        body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 10px; color: #333; line-height: 1.2; }
        
        /* HEADER */
        .header-tbl { width: 100%; border-bottom: 2px solid #356685; margin-bottom: 15px; padding-bottom: 5px; }
        .logo-img { height: 60px; width: auto; object-fit: contain; display: block; }
        .title { font-size: 18px; font-weight: 900; color: #356685; text-transform: uppercase; }
        .subtitle { font-size: 10px; color: #666; }

        /* TABLAS DE DATOS */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .main-table th { 
            background: #2c3e50; color: white; padding: 6px 4px; 
            text-align: right; font-size: 8px; font-weight: bold; border: 1px solid #1a252f;
            vertical-align: middle;
        }
        .main-table th.left { text-align: left; }
        .main-table td { padding: 5px 4px; border: 1px solid #ddd; text-align: right; font-size: 9px; }
        .main-table td.left { text-align: left; }
        
        /* COLORES Y ESTILOS DE CELDAS */
        .bg-venta { background-color: #eafaf1; font-weight: bold; }
        .bg-fiscal { background-color: #ebf5fb; }
        .bg-nofiscal { background-color: #fff5f5; }
        .total-row td { background-color: #e2e6ea; font-weight: bold; border-top: 2px solid #333; }
        
        .text-red { color: #c0392b; }
        .text-blue { color: #2980b9; }
        .text-green { color: #27ae60; }
        
        /* CAJAS DE RESUMEN (LAYOUT TABLE) */
        .summary-wrapper { width: 100%; margin-top: 20px; page-break-inside: avoid; }
        
        /* Estilos de las cajas como tablas anidadas */
        .box-container {
            border: 1px solid #ccc;
            border-radius: 6px;
            overflow: hidden;
            background-color: #fcfcfc;
        }
        .box-header {
            padding: 8px; font-weight: bold; text-transform: uppercase; font-size: 11px;
            border-bottom: 1px solid #ccc;
        }
        .inner-table { width: 100%; border-collapse: collapse; }
        .inner-table td { padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 10px; }
        .inner-table tr:last-child td { border-bottom: none; }
        
        .label-col { text-align: left; color: #555; width: 60%; }
        .value-col { text-align: right; font-weight: bold; width: 40%; }
        
        .final-total-row td {
            background-color: #eee; border-top: 2px solid #aaa; font-size: 12px; font-weight: 900;
        }

    </style>
</head>
<body>

    <table class="header-tbl">
        <tr>
            <td width="40%">
                <table style="width: 100%;">
                    <tr>
                        {% if logo_url %}
                        <td style="width: 70px; border: none; padding: 0;">
                            <img src="{{ logo_url }}" class="logo-img">
                        </td>
                        {% endif %}
                        <td style="border: none; padding-left: 10px; vertical-align: middle;">
                            <h3 style="margin: 0; color: #333; font-size: 16px;">QUINTA KO'OX TANIL</h3>
                        </td>
                    </tr>
                </table>
            </td>
            <td width="60%" style="text-align: right;">
                <div class="title">Estado De Resultados</div>
                <div class="subtitle">Desglose De Ingresos, Gastos, Costos y Utilidad.</div>
                <div style="font-size: 9px; margin-top: 5px;">
                    <strong>Periodo:</strong> {{ fecha_inicio|default:"Inicio" }} al {{ fecha_fin|default:"Hoy" }}
                </div>
            </td>
        </tr>
    </table>

    <h4 style="margin: 0 0 5px 0; color: #356685; border-bottom: 1px solid #ccc;">1. INGRESOS POR EVENTO</h4>
    <table class="main-table">
        <thead>
            <tr>
                <th class="left" width="4%">ID</th>
                <th class="left" width="16%">Cliente / Evento</th>
                
                <th width="8%" style="background:#27ae60;">Ingreso Total</th>
                <th width="7%" style="background:#2ecc71;">(-) IVA Trasladado</th>
                <th width="8%" style="background:#2ecc71;">(=) Base Real</th>
                
                <th width="8%" style="background:#2980b9;">(-) Gto Facturado<br>(Base)</th>
                <th width="7%" style="background:#3498db;">(+) IVA Acreditable</th>
                
                <th width="8%" style="background:#c0392b;">(-) Gto No Facturado<br>(Nota)</th>
                
                <th width="9%" style="background:#2c3e50;">(=) Utilidad<br>Bruta</th>
            </tr>
        </thead>
        <tbody>
            {% for d in datos %}
            <tr>
                <td class="left">{{ d.folio }}</td>
                <td class="left">
                    <b>{{ d.cliente|truncatechars:20 }}</b><br>
                    <span style="color:#777; font-size:8px;">{{ d.producto|truncatechars:25 }}</span>
                </td>
                
                <td class="bg-venta">${{ d.venta_total|floatformat:2|intcomma }}</td>
                <td class="text-red">-${{ d.iva_trasladado|floatformat:2|intcomma }}</td>
                <td style="font-weight:bold;">${{ d.base_real_venta|floatformat:2|intcomma }}</td>
                
                <td class="bg-fiscal text-red">-${{ d.gasto_fiscal_base|floatformat:2|intcomma }}</td>
                <td class="bg-fiscal text-blue">+${{ d.iva_acreditable|floatformat:2|intcomma }}</td>
                
                <td class="bg-nofiscal text-red">-${{ d.gasto_nofiscal|floatformat:2|intcomma }}</td>
                
                <td style="font-weight:bold; color:#218838;">${{ d.utilidad|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="9" style="text-align:center; padding:10px;">Sin registros en este periodo.</td></tr>
            {% endfor %}
            
            <tr class="total-row">
                <td colspan="2" class="left">TOTALES</td>
                <td>${{ t_venta_total|floatformat:2|intcomma }}</td>
                <td class="text-red">-${{ t_iva_trasladado|floatformat:2|intcomma }}</td>
                <td>${{ t_base_real|floatformat:2|intcomma }}</td>
                
                <td class="text-red">-${{ t_ev_fiscal_base|floatformat:2|intcomma }}</td>
                <td class="text-blue">+${{ t_ev_iva|floatformat:2|intcomma }}</td>
                <td class="text-red">-${{ t_ev_nofiscal|floatformat:2|intcomma }}</td>
                
                <td>-</td>
            </tr>
        </tbody>
    </table>

    <h4 style="margin: 15px 0 5px 0; color: #356685; border-bottom: 1px solid #ccc;">2. GASTOS OPERATIVOS</h4>
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td width="49%" style="vertical-align: top; padding-right: 5px;">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="left" style="background:#555;">Gasto Facturado (Deducible)</th>
                            <th width="20%" style="background:#555;">Base</th>
                            <th width="20%" style="background:#555;">IVA</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in gastos_operativos_fiscales_list %}
                        <tr>
                            <td class="left">{{ item.nombre }}</td>
                            <td>${{ item.base|floatformat:2|intcomma }}</td>
                            <td class="text-blue">${{ item.iva|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td class="left">SUBTOTAL</td>
                            <td class="text-red">-${{ t_op_fiscal_base|floatformat:2|intcomma }}</td>
                            <td class="text-blue">+${{ t_op_iva|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </td>
            
            <td width="49%" style="vertical-align: top; padding-left: 5px;">
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="left" style="background:#777;">Gasto No Facturado (No Deducible)</th>
                            <th width="30%" style="background:#777;">Total Pagado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in gastos_operativos_nofiscales_list %}
                        <tr>
                            <td class="left">{{ item.nombre }}</td>
                            <td class="text-red">${{ item.total|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td class="left">SUBTOTAL</td>
                            <td class="text-red">-${{ t_op_nofiscal|floatformat:2|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </table>

    <table class="summary-wrapper">
        <tr>
            <td width="48%" style="vertical-align: top;">
                <div class="box-container" style="border-color: #28a745;">
                    <div class="box-header" style="background-color: #eafaf1; color: #1e7e34;">
                        RENTABILIDAD REAL DEL NEGOCIO
                    </div>
                    <table class="inner-table">
                        <tr>
                            <td class="label-col">Ingresos Reales (Sin IVA):</td>
                            <td class="value-col">${{ t_base_real|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="label-col">(-) Costos Facturados (Deducible):</td>
                            <td class="value-col text-red">-${{ total_costos_base|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="label-col">(-) Costos No Facturados (No Deducible):</td>
                            <td class="value-col text-red">-${{ total_costos_nofiscal|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr class="final-total-row">
                            <td class="label-col" style="color:#000;">UTILIDAD NETA:</td>
                            <td class="value-col text-green">${{ utilidad_neta_real|floatformat:2|intcomma }}</td>
                        </tr>
                    </table>
                </div>
            </td>
            
            <td width="4%"></td> 
            <td width="48%" style="vertical-align: top;">
                <div class="box-container" style="border-color: #3498db;">
                    <div class="box-header" style="background-color: #ebf5fb; color: #0c5460;">
                        CÁLCULO DE IVA (ESTIMADO)
                    </div>
                    <table class="inner-table">
                        <tr>
                            <td class="label-col">(+) IVA Cobrado (Ventas):</td>
                            <td class="value-col">${{ t_iva_trasladado|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="label-col">(-) IVA Acreditable (Eventos):</td>
                            <td class="value-col text-blue">-${{ t_ev_iva|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="label-col">(-) IVA Acreditable (Gastos):</td>
                            <td class="value-col text-blue">-${{ t_op_iva|floatformat:2|intcomma }}</td>
                        </tr>
                        <tr class="final-total-row">
                            <td class="label-col" style="color:#000;">IVA POR PAGAR:</td>
                            <td class="value-col" style="color:#d35400;">${{ iva_por_pagar|floatformat:2|intcomma }}</td>
                        </tr>
                    </table>
                </div>
                <div style="font-size:8px; color:#888; text-align:center; padding-top:5px;">
                    * Solo facturas con UUID válido deducen impuestos.
                </div>
            </td>
        </tr>
    </table>

</body>
</html>