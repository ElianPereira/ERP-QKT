{% extends "admin/base_site.html" %}
{% load humanize %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .dashboard-container { max-width: 1200px; margin: 20px auto; font-family: -apple-system, sans-serif; }
    
    /* ACTIONS GRID */
    .actions-grid { 
        display: grid; 
        grid-template-columns: repeat(5, 1fr); 
        gap: 15px; 
        margin-bottom: 30px; 
    }

    .action-btn {
        background: white; border-radius: 12px; padding: 15px; text-align: center; 
        text-decoration: none; color: #333; border: 1px solid #e0e0e0; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        display: flex; flex-direction: column; align-items: center; justify-content: center; height: 110px;
        transition: transform 0.2s;
    }
    .action-btn:hover { transform: translateY(-3px); border-color: #356685; }
    .action-icon { font-size: 28px; margin-bottom: 10px; }
    .action-label { font-size: 13px; font-weight: 700; color: #444; }

    /* ICON COLORS */
    .icon-cotizacion { color: #356685; } 
    .icon-gasto { color: #dc3545; } 
    .icon-factura { color: #17a2b8; } 
    .icon-nomina { color: #28a745; }
    .icon-compras { color: #e67e22; }

    /* KPI CARDS */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
    .kpi-card { background: white; border-radius: 12px; padding: 15px; border-left: 5px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .kpi-title { font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; }
    .kpi-value { font-size: 24px; font-weight: 800; color: #333; margin-top: 5px; }

    /* GR√ÅFICAS */
    .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 40px; }
    .content-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }

</style>

<div class="dashboard-container">
    <h2 style="margin-bottom: 25px; color: #333;">Tablero de Control</h2>

    <div class="actions-grid">
        <a href="{% url 'admin:comercial_cotizacion_add' %}" class="action-btn">
            <div class="action-icon icon-cotizacion"><i class="fas fa-plus-circle"></i></div>
            <div class="action-label">Nueva Cotizaci√≥n</div>
        </a>
        
        <a href="{% url 'generar_lista_compras' %}" class="action-btn"> 
            <div class="action-icon icon-compras"><i class="fas fa-shopping-cart"></i></div>
            <div class="action-label">Lista de Compras</div>
        </a>
        
        <a href="{% url 'crear_solicitud' %}" class="action-btn">
            <div class="action-icon icon-factura"><i class="fas fa-file-invoice-dollar"></i></div>
            <div class="action-label">Facturar</div>
        </a>
        
        <a href="{% url 'admin:comercial_gasto_add' %}" class="action-btn">
            <div class="action-icon icon-gasto"><i class="fas fa-receipt"></i></div>
            <div class="action-label">Gastos</div>
        </a>
        
        <a href="{% url 'admin:nomina_recibonomina_changelist' %}" class="action-btn">
            <div class="action-icon icon-nomina"><i class="fas fa-users"></i></div>
            <div class="action-label">N√≥mina</div>
        </a>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card" style="border-left-color: #2ecc71;">
            <div class="kpi-title">Ventas Mes</div>
            <div class="kpi-value" style="color: #2ecc71;">${{ ventas_mes|floatformat:0|intcomma }}</div>
        </div>
        <div class="kpi-card" style="border-left-color: #e74c3c;">
            <div class="kpi-title">Gastos Mes</div> 
            <div class="kpi-value" style="color: #e74c3c;">${{ gastos_mes|floatformat:0|intcomma }}</div>
        </div>
        <div class="kpi-card" style="border-left-color: #f39c12;">
            <div class="kpi-title">Utilidad Neta</div> 
            <div class="kpi-value" style="color: #f39c12;">${{ utilidad_mes|floatformat:0|intcomma }}</div>
        </div>
        <div class="kpi-card" style="border-left-color: #3498db;">
            <div class="kpi-title">Pr√≥ximo Evento</div>
            {% if proximo_evento %}
                <div class="kpi-value" style="font-size: 18px;">{{ proximo_evento.fecha_evento|date:"d M" }}</div>
                <div style="font-size: 10px; color:#999;">{{ proximo_evento.cliente.nombre|truncatechars:15 }}</div>
            {% else %}
                <div class="kpi-value">-</div>
            {% endif %}
        </div>
    </div>

    <div class="main-grid">
        <div class="content-card">
            <div style="font-weight: bold; margin-bottom: 15px; color: #555;">üìä Finanzas (Ventas vs Gastos)</div>
            <canvas id="financeChart" height="120"></canvas>
        </div>

        <div class="content-card">
            <div style="font-weight: bold; margin-bottom: 15px; color: #555;">üìÖ Agenda R√°pida</div>
            {% if ultimos_eventos %}
                {% for evento in ultimos_eventos %}
                <div style="padding: 10px 0; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center;">
                    <div style="background: #e3f2fd; color: #1565c0; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 11px; margin-right: 10px;">
                        {{ evento.fecha_evento|date:"d M" }}
                    </div>
                    <div>
                        <div style="font-size: 13px; font-weight: 600;">{{ evento.cliente.nombre }}</div>
                        <div style="font-size: 11px; color: #999;">{{ evento.producto.nombre }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color:#ccc; text-align:center;">Sin eventos pr√≥ximos.</p>
            {% endif %}
            <div style="margin-top:15px; text-align:center;">
                <a href="{% url 'ver_calendario' %}" style="color: #3498db; font-size: 12px; font-weight: bold;">Ver Todo ‚Üí</a>
            </div>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('financeChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [
                {
                    label: 'Ventas ($)',
                    data: {{ chart_ventas|safe }},
                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    borderRadius: 4
                },
                {
                    label: 'Gastos ($)',
                    data: {{ chart_gastos|safe }},
                    backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true, grid: { borderDash: [5, 5] } }, x: { grid: { display: false } } }
        }
    });
</script>
{% endblock %}