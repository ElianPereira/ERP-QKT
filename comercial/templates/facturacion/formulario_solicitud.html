{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}

<style>
    .form-wrapper { max-width: 1000px; margin: 20px auto; }
    .custom-grid { display: grid; grid-template-columns: 1fr 1fr; column-gap: 30px; row-gap: 20px; }
    .full-width { grid-column: span 2; }
    @media (max-width: 768px) { .custom-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    .section-divider { color: #356685; font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid #eaeaea; padding-bottom: 10px; margin-bottom: 20px; margin-top: 20px; }
    .section-divider i { margin-right: 8px; }
    label { font-weight: 600 !important; color: #333; margin-bottom: 5px; }
    .form-control { height: auto !important; padding: 10px 12px !important; }
</style>

<div class="form-wrapper">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Nueva Solicitud de Factura</h3>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="section-divider" style="margin-top: 0;">
                    <i class="fas fa-link"></i> 1. Origen y Cliente
                </div>
                
                <div class="custom-grid">
                    <div class="form-group">
                        <label>Cliente</label>
                        <select name="cliente_id" id="select_cliente" class="form-control" required onchange="llenarDatos()">
                            <option value="">-- Buscar Cliente --</option>
                            {% for c in clientes %}
                                <option value="{{ c.id }}" 
                                    data-rfc="{{ c.rfc|default:'' }}"
                                    data-razon="{{ c.razon_social|default:'' }}"
                                    data-cp="{{ c.codigo_postal_fiscal|default:'' }}"
                                    data-regimen="{{ c.regimen_fiscal|default:'' }}"
                                    data-uso="{{ c.uso_cfdi|default:'' }}">
                                    {{ c.nombre }} {% if c.razon_social %} - {{ c.razon_social }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Vincular a Cotización (Opcional)</label>
                        <select name="cotizacion_id" class="form-control">
                            <option value="">-- Venta Directa --</option>
                            {% for cot in cotizaciones %}
                                <option value="{{ cot.id }}">
                                    COT-{{ cot.id|stringformat:"03d" }} | {{ cot.cliente.nombre }} (${{ cot.precio_final }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="section-divider">
                    <i class="fas fa-building"></i> 2. Datos Fiscales
                </div>

                <div class="custom-grid">
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" name="rfc" id="input_rfc" class="form-control" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Razón Social</label>
                        <input type="text" name="razon_social" id="input_razon" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Código Postal</label>
                        <input type="text" name="cp" id="input_cp" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Régimen Fiscal</label>
                        <select name="regimen_fiscal" id="input_regimen" class="form-control">
                            <option value="">-- Seleccionar --</option>
                            <option value="601">601 - General de Ley P.M.</option>
                            <option value="612">612 - Personas Físicas Act. Emp.</option>
                            <option value="626">626 - RESICO</option>
                            <option value="605">605 - Sueldos y Salarios</option>
                            <option value="603">603 - Morales sin Fines Lucrativos</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Uso de CFDI</label>
                        <select name="uso_cfdi" id="input_uso" class="form-control">
                            <option value="">-- Seleccionar --</option>
                            <option value="G03">G03 - Gastos en general</option>
                            <option value="P01">P01 - Por definir</option>
                            <option value="G01">G01 - Adquisición de mercancías</option>
                            <option value="D04">D04 - Donativos</option>
                        </select>
                    </div>
                </div>

                <div class="section-divider">
                    <i class="fas fa-list-alt"></i> 3. Detalles de Factura
                </div>

                <div class="custom-grid">
                    <div class="form-group">
                        <label>Monto Total (Con IVA)</label>
                        <div class="input-group">
                            <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                            <input type="number" step="0.01" name="monto" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Forma de Pago</label>
                        <select name="forma_pago" class="form-control">
                            <option value="03 - Transferencia electrónica de fondos">03 - Transferencia</option>
                            <option value="01 - Efectivo">01 - Efectivo</option>
                            <option value="04 - Tarjeta de crédito">04 - Tarjeta de crédito</option>
                            <option value="28 - Tarjeta de débito">28 - Tarjeta de débito</option>
                            <option value="99 - Por definir">99 - Por definir</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Método de Pago</label>
                        <select name="metodo_pago" class="form-control">
                            <option value="PUE - Pago en una sola exhibición">PUE - Una sola exhibición</option>
                            <option value="PPD - Pago en parcialidades o diferido">PPD - Parcialidades</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Concepto</label>
                        <textarea name="concepto" class="form-control" rows="3" required></textarea>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-info btn-block btn-lg" style="background-color: #17a2b8; border-color: #17a2b8;">
                        <i class="fas fa-save"></i> Generar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function llenarDatos() {
        var select = document.getElementById('select_cliente');
        var option = select.options[select.selectedIndex];
        if(option.value) {
            document.getElementById('input_rfc').value = option.getAttribute('data-rfc');
            document.getElementById('input_razon').value = option.getAttribute('data-razon');
            document.getElementById('input_cp').value = option.getAttribute('data-cp');
            
            seleccionarEnDropdown('input_regimen', option.getAttribute('data-regimen'));
            seleccionarEnDropdown('input_uso', option.getAttribute('data-uso'));
        }
    }
    function seleccionarEnDropdown(idSelect, valorBuscado) {
        var select = document.getElementById(idSelect);
        if (!valorBuscado) { select.selectedIndex = 0; return; }
        for (var i = 0; i < select.options.length; i++) {
            if (valorBuscado.indexOf(select.options[i].value) > -1) {
                select.selectedIndex = i;
                break;
            }
        }
    }
</script>
{% endblock %}