{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotización #{{ cotizacion.id }}</title>
    <style>
        @page { size: letter; margin: 1.5cm; }
        body { 
            font-family: 'Helvetica', sans-serif; 
            color: #333; 
            margin: 0; padding: 0; 
            font-size: 12px; 
        }
        .clearfix { clear: both; }

        /* HEADER */
        .header-container { width: 100%; margin-bottom: 20px; }
        .header-table { width: 100%; border: none; }
        .header-table td { vertical-align: top; }
        .company-name { font-size: 18px; font-weight: bold; color: #356685; margin-bottom: 5px; }
        .company-details { font-size: 11px; color: #666; line-height: 1.4; }

        /* TÍTULO */
        .doc-title { text-align: center; margin-top: 5px; margin-bottom: 15px; }
        .doc-title h1 { margin: 0; color: #2c3e50; font-size: 20px; }
        .doc-title p { margin: 2px 0 0 0; color: #7f8c8d; font-size: 10px; }

        /* TARJETA DE DATOS */
        .info-card {
            border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px;
            background-color: #fcfcfc; margin-bottom: 20px; position: relative; display: block;
        }
        .card-table { width: 100%; }
        .card-label { color: #356685; font-weight: bold; width: 100px; }
        .card-value { color: #333; }

        /* TABLA DE DETALLE */
        .data-table {
            width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px;
            border-bottom: 2px solid #356685;
        }
        .data-table th {
            background-color: #4a86a6; color: white; padding: 8px; text-align: left;
            font-weight: normal; font-size: 11px; border: none;
        }
        .data-table th:first-child { border-top-left-radius: 5px; padding-left: 15px; }
        .data-table th:last-child { border-top-right-radius: 5px; padding-right: 15px; text-align: right;} 
        
        .data-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; color: #555; font-size: 11px; }
        .data-table td:first-child { text-align: left; padding-left: 15px; }
        .data-table td:last-child { text-align: right; padding-right: 15px; }
        .data-table tr:last-child td { border-bottom: none; }

        /* Sub-items (los subproductos dentro del paquete) */
        .sub-item-row td { 
            background-color: #fdfdfd; 
            color: #777; 
            font-size: 10px; 
            padding-top: 2px; 
            padding-bottom: 2px;
            border-bottom: none;
        }

        /* ABONOS */
        .payments-table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 10px; }
        .payments-table th { border-bottom: 1px solid #999; text-align: left; padding: 4px; color: #666; }
        .payments-table td { border-bottom: 1px solid #eee; padding: 4px; color: #333; }

        /* TOTALES */
        .totals-section { margin-top: 20px; width: 100%; page-break-inside: avoid; }
        .totals-table { float: right; width: 260px; border: 1px solid #eee; border-radius: 5px; padding: 10px; background-color: #fcfcfc;}
        .total-row { margin-bottom: 4px; font-size: 11px; }
        
        .grand-total {
            background-color: #356685; color: white; padding: 6px; text-align: center;
            border-radius: 4px; font-weight: bold; font-size: 13px; margin-top: 8px;
        }
        
        .balance-row { color: #d9534f; font-weight: bold; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px;}
        .abono-text { color: #28a745; }

        /* FIRMAS Y PIE */
        .signature-section { margin-top: 40px; width: 100%; page-break-inside: avoid; }
        .signature-box { width: 45%; float: left; text-align: center; }
        .signature-line { border-top: 1px solid #333; width: 80%; margin: 0 auto 5px auto; }
        .digital-seal { font-size: 7px; color: #999; margin-top: 5px; font-family: 'Courier New', monospace; word-break: break-all; }
        
        .footer-msg {
            position: absolute; bottom: 0; width: 100%; text-align: center; 
            color: #ccc; font-size: 8px; border-top: 1px solid #eee; padding-top: 5px;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <table class="header-table">
            <tr>
                <td style="width: 50%;">
                    <img src="{{ logo_url }}" style="height: 60px; display: block;">
                </td>
                <td style="width: 50%; text-align: right;">
                    <div class="company-name">Quinta Ko'ox Tanil</div>
                    <div class="company-details">
                        Ctra Tanil - Ticimul KM 1.920<br>Umán, Yucatán<br>quintakooxtanil@gmail.com
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="doc-title">
        <h1>Cotización de Evento</h1>
        <p>Folio: COT-{{ cotizacion.id|stringformat:"03d" }}</p>
    </div>

    <div class="info-card">
        <table class="card-table">
            <tr>
                <td style="width: 60%;">
                    <table style="width: 100%;">
                        <tr>
                            <td class="card-label">Cliente:</td>
                            <td class="card-value" style="text-transform: uppercase;">{{ cotizacion.cliente.nombre }}</td>
                        </tr>
                        <tr>
                            <td class="card-label">Evento:</td>
                            <td class="card-value">{{ cotizacion.nombre_evento }}</td>
                        </tr>
                        <tr>
                            <td class="card-label">Email:</td>
                            <td class="card-value">{{ cotizacion.cliente.email|default:"-" }}</td>
                        </tr>
                    </table>
                </td>
                <td style="width: 40%;">
                    <table style="width: 100%;">
                        <tr>
                            <td class="card-label" style="text-align: right;">Fecha Evento:</td>
                            <td class="card-value" style="text-align: right;">{{ cotizacion.fecha_evento|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <td class="card-label" style="text-align: right;">Horario:</td>
                            <td class="card-value" style="text-align: right;">
                                {% if cotizacion.hora_inicio %}
                                    {{ cotizacion.hora_inicio|date:"H:i" }} - {{ cotizacion.hora_fin|date:"H:i" }}
                                {% else %}
                                    Por definir
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="card-label" style="text-align: right;">Emisión:</td>
                            <td class="card-value" style="text-align: right;">{% now "d/m/Y H:i" %}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 70%">Concepto</th>
                <th style="width: 15%; text-align: center;">Cantidad</th>
                <th style="width: 15%; text-align: right;">Importe</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
                <tr style="font-weight: bold; color: #333;">
                    <td>
                        {% if item.producto %}
                            {{ item.producto.nombre }}
                            <br><span style="font-size: 9px; font-weight: normal; color: #888;">{{ item.descripcion|default:"Paquete contratado" }}</span>
                        {% elif item.insumo %}
                            {{ item.insumo.nombre }}
                            <br><span style="font-size: 9px; font-weight: normal; color: #888;">{{ item.descripcion|default:"Servicio Contratado" }}</span>
                        {% else %}
                            {{ item.descripcion }}
                        {% endif %}

                        {# --- DETALLE DINÁMICO DE BARRA --- #}
                        {% if "Servicio de Barra" in item.descripcion %}
                            <div style="margin-top: 4px; font-size: 9px; color: #555; font-weight: normal; font-style: italic; line-height: 1.3; padding-left: 2px;">
                                <strong style="color: #356685;">Incluye:</strong>
                                {% if cotizacion.incluye_refrescos %}
                                    Refrescos, Mezcladores y Agua |
                                {% endif %}
                                {% if cotizacion.incluye_cerveza %}
                                    Cerveza Nacional |
                                {% endif %}
                                {% if cotizacion.incluye_licor %}
                                    Licores Premium (Tequila, Ron, Vodka, Whisky) |
                                {% endif %}
                                {% if cotizacion.incluye_cocteleria %}
                                    Estación de Mixología (Mojitos, Margaritas, Gin Tonics) |
                                {% endif %}
                                <strong style="color: #356685;">Staff de Barra.</strong>
                            </div>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">{{ item.cantidad|floatformat:2 }}</td>
                    <td style="text-align: right;">${{ item.subtotal|floatformat:2|intcomma }}</td>
                </tr>

                {% if item.producto %}
                    {% for componente in item.producto.componentes.all %}
                    <tr class="sub-item-row">
                        <td style="padding-left: 25px;">
                             • {{ componente.subproducto.nombre }} 
                             <span style="color: #aaa; font-size: 9px;">(Incluye: {{ componente.cantidad }} pzas/u)</span>
                        </td>
                        <td style="text-align: center;">-</td>
                        <td style="text-align: right; font-size: 9px; color: #28a745;"><i>Incluido</i></td>
                    </tr>
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    {% if cotizacion.pagos.exists %}
    <div style="margin-top: 20px; margin-bottom: 15px;">
        <h4 style="color: #356685; margin-bottom: 5px; border-bottom: 1px solid #ccc; font-size: 11px;">Historial de Abonos</h4>
        <table class="payments-table" style="margin-top: 0;">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Método</th>
                    <th>Referencia</th>
                    <th>Recibido Por</th>
                    <th style="text-align: right;">Monto</th>
                </tr>
            </thead>
            <tbody>
                {% for pago in cotizacion.pagos.all %}
                <tr>
                    <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                    <td>{{ pago.metodo }}</td>
                    <td>{{ pago.referencia|default:"-" }}</td>
                    <td>{{ pago.usuario.first_name|default:"Sistema" }}</td>
                    <td style="text-align: right; color: #28a745; font-weight: bold;">
                        ${{ pago.monto|floatformat:2|intcomma }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="totals-section">
        <div class="totals-table">
            <div class="total-row">
                <span style="float:left;">Subtotal Global:</span>
                <span style="float:right;">${{ cotizacion.subtotal|floatformat:2|intcomma }}</span>
                <div class="clearfix"></div>
            </div>

            {% if cotizacion.descuento > 0 %}
            <div class="total-row" style="color: #d9534f;">
                <span style="float:left;">(-) Descuento:</span>
                <span style="float:right;">- ${{ cotizacion.descuento|floatformat:2|intcomma }}</span>
                <div class="clearfix"></div>
            </div>
            {% endif %}

            {% if cotizacion.iva > 0 %}
            <div class="total-row">
                <span style="float:left;">(+) IVA (16%):</span>
                <span style="float:right;">${{ cotizacion.iva|floatformat:2|intcomma }}</span>
                <div class="clearfix"></div>
            </div>
            {% endif %}

            {% if cotizacion.retencion_isr > 0 %}
            <div class="total-row">
                <span style="float:left; color:#900;">(-) Retención ISR:</span>
                <span style="float:right; color:#900;">- ${{ cotizacion.retencion_isr|floatformat:2|intcomma }}</span>
                <div class="clearfix"></div>
            </div>
            {% endif %}
            
            <div class="grand-total">
                <span style="float:left;">PRECIO TOTAL:</span>
                <span style="float:right;">${{ cotizacion.precio_final|floatformat:2|intcomma }}</span>
                <div class="clearfix"></div>
            </div>

            <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 8px;">
                 <div class="total-row abono-text">
                    <span style="float:left;">Abonado:</span>
                    <span style="float:right;">- ${{ total_pagado|floatformat:2|intcomma }}</span>
                    <div class="clearfix"></div>
                </div>
                
                <div class="total-row balance-row">
                    <span style="float:left;">PENDIENTE:</span>
                    <span style="float:right;">${{ saldo_pendiente|floatformat:2|intcomma }}</span>
                    <div class="clearfix"></div>
                </div>
            </div>

        </div>
        <div class="clearfix"></div>
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <div class="signature-line"></div>
            <strong>{{ cotizacion.cliente.nombre }}</strong><br>
            <span style="font-size: 10px; color: #666;">Acepto Cotización</span>
        </div>
        
        <div class="signature-box" style="float: right;">
            <div class="signature-line"></div>
            <strong>Elaborado por: {{ cotizacion.usuario.first_name|default:"Administración" }} {{ cotizacion.usuario.last_name }}</strong><br>
            <span style="font-size: 10px; color: #666;">Quinta Ko'ox Tanil</span>
            
            <div class="digital-seal">
                Sello Digital: {{ cotizacion.id }}|{{ cotizacion.fecha_evento|date:"Ymd" }}|{{ cotizacion.created_at|date:"His" }}|{{ cotizacion.usuario.username|default:"SYS" }}|QKT-SECURE
            </div>
        </div>
        <div class="clearfix"></div>
    </div>

    <div class="footer-msg">
        Gracias por confiar en Quinta Ko'ox Tanil.
    </div>

</body>
</html>