{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}

<style>
    .form-wrapper { max-width: 1000px; margin: 20px auto; }
    .custom-grid { display: grid; grid-template-columns: 1fr 1fr; column-gap: 30px; row-gap: 20px; }
    .full-width { grid-column: span 2; }
    @media (max-width: 768px) { .custom-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    .section-divider { color: #356685; font-size: 1.1rem; font-weight: 600; border-bottom: 1px solid #eaeaea; padding-bottom: 10px; margin-bottom: 20px; margin-top: 20px; }
    .section-divider i { margin-right: 8px; }
    label { font-weight: 600 !important; color: #333; margin-bottom: 5px; }
    .form-control { height: auto !important; padding: 10px 12px !important; }
</style>

<div class="form-wrapper">
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> Nueva Solicitud de Factura</h3>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="section-divider" style="margin-top: 0;">
                    <i class="fas fa-link"></i> 1. Origen y Cliente
                </div>
                
                <div class="custom-grid">
                    <div class="form-group">
                        <label>Cliente</label>
                        <select name="cliente_id" id="select_cliente" class="form-control" required onchange="llenarDatos()">
                            <option value="">-- Buscar Cliente --</option>
                            {% for c in clientes %}
                                <option value="{{ c.id }}" 
                                    data-rfc="{{ c.rfc|default:'' }}"
                                    data-razon="{{ c.razon_social|default:'' }}"
                                    data-cp="{{ c.codigo_postal_fiscal|default:'' }}"
                                    data-regimen="{{ c.regimen_fiscal|default:'' }}"
                                    data-uso="{{ c.uso_cfdi|default:'' }}">
                                    {{ c.nombre }} {% if c.razon_social %} - {{ c.razon_social }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Vincular a Cotización (Opcional)</label>
                        <select name="cotizacion_id" class="form-control">
                            <option value="">-- Venta Directa --</option>
                            {% for cot in cotizaciones %}
                                <option value="{{ cot.id }}">
                                    COT-{{ cot.id|stringformat:"03d" }} | {{ cot.cliente.nombre }} (${{ cot.precio_final }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="section-divider">
                    <i class="fas fa-building"></i> 2. Datos Fiscales
                </div>

                <div class="custom-grid">
                    <div class="form-group">
                        <label>RFC</label>
                        <input type="text" name="rfc" id="input_rfc" class="form-control" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Razón Social</label>
                        <input type="text" name="razon_social" id="input_razon" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Código Postal</label>
                        <input type="text" name="cp" id="input_cp" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Régimen Fiscal</label>
                        <select name="regimen_fiscal" id="input_regimen" class="form-control">
                            <option value="">-- Seleccionar --</option>
                            <optgroup label="Personas Morales">
                                <option value="601">601 - General de Ley Personas Morales</option>
                                <option value="603">603 - Personas Morales con Fines no Lucrativos</option>
                                <option value="626">626 - RESICO (Morales)</option>
                                <option value="623">623 - Opcional para Grupos de Sociedades</option>
                                <option value="624">624 - Coordinados</option>
                            </optgroup>
                            <optgroup label="Personas Físicas">
                                <option value="612">612 - Personas Físicas Act. Empresariales</option>
                                <option value="626">626 - RESICO (Físicas)</option>
                                <option value="605">605 - Sueldos y Salarios</option>
                                <option value="606">606 - Arrendamiento</option>
                                <option value="621">621 - Incorporación Fiscal (RIF)</option>
                                <option value="625">625 - Plataformas Tecnológicas</option>
                                <option value="616">616 - Sin obligaciones fiscales</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Uso de CFDI</label>
                        <select name="uso_cfdi" id="input_uso" class="form-control">
                            <option value="">-- Seleccionar --</option>
                            <optgroup label="Gastos">
                                <option value="G03">G03 - Gastos en general</option>
                                <option value="G01">G01 - Adquisición de mercancías</option>
                                <option value="G02">G02 - Devoluciones, descuentos o bonificaciones</option>
                            </optgroup>
                            <optgroup label="Inversiones">
                                <option value="I01">I01 - Construcciones</option>
                                <option value="I02">I02 - Mobiliario y equipo de oficina</option>
                                <option value="I03">I03 - Equipo de transporte</option>
                                <option value="I04">I04 - Equipo de cómputo</option>
                            </optgroup>
                            <optgroup label="Deducciones Personales">
                                <option value="D01">D01 - Honorarios médicos</option>
                                <option value="D02">D02 - Gastos médicos por incapacidad</option>
                                <option value="D10">D10 - Pagos por servicios educativos</option>
                            </optgroup>
                            <optgroup label="Otros">
                                <option value="S01">S01 - Sin efectos fiscales</option>
                                <option value="CP01">CP01 - Pagos</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="section-divider">
                    <i class="fas fa-list-alt"></i> 3. Detalles de Factura
                </div>

                <div class="custom-grid">
                    <div class="form-group">
                        <label>Monto Total (Con IVA)</label>
                        <div class="input-group">
                            <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                            <input type="number" step="0.01" name="monto" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Forma de Pago</label>
                        <select name="forma_pago" class="form-control">
                            <option value="03">03 - Transferencia electrónica de fondos</option>
                            <option value="01">01 - Efectivo</option>
                            <option value="04">04 - Tarjeta de crédito</option>
                            <option value="28">28 - Tarjeta de débito</option>
                            <option value="02">02 - Cheque nominativo</option>
                            <option value="99">99 - Por definir</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Método de Pago</label>
                        <select name="metodo_pago" class="form-control">
                            <option value="PUE">PUE - Pago en una sola exhibición</option>
                            <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Concepto</label>
                        <textarea name="concepto" class="form-control" rows="3" required></textarea>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-info btn-block btn-lg" style="background-color: #17a2b8; border-color: #17a2b8;">
                        <i class="fas fa-save"></i> Generar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function llenarDatos() {
        var select = document.getElementById('select_cliente');
        var option = select.options[select.selectedIndex];
        if(option.value) {
            document.getElementById('input_rfc').value = option.getAttribute('data-rfc');
            document.getElementById('input_razon').value = option.getAttribute('data-razon');
            document.getElementById('input_cp').value = option.getAttribute('data-cp');
            
            // La magia está aquí: como ahora los 'value' del HTML coinciden con los códigos
            // de la base de datos (ej: '601', 'G03'), esto seleccionará la opción correcta automáticamente.
            var regimen = option.getAttribute('data-regimen');
            if(regimen) document.getElementById('input_regimen').value = regimen;

            var uso = option.getAttribute('data-uso');
            if(uso) document.getElementById('input_uso').value = uso;
        }
    }
</script>
{% endblock %}