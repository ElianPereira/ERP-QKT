{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Rentabilidad</title>
    <style>
        @page { size: letter landscape; margin: 0.5cm; } /* Reduje márgenes para acomodar la nueva columna */
        
        body { font-family: 'Helvetica', sans-serif; color: #333; font-size: 8.5px; } 
        
        /* ENCABEZADO */
        .header { width: 100%; border-bottom: 2px solid #356685; margin-bottom: 10px; padding-bottom: 10px; }
        .header td { vertical-align: middle; }
        .title { font-size: 18px; font-weight: bold; color: #356685; text-transform: uppercase; }
        .subtitle { font-size: 10px; color: #666; }
        
        /* TABLA PRINCIPAL */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        
        .main-table th {
            background-color: #356685; color: white; padding: 5px 2px;
            text-align: right; font-size: 8px; font-weight: bold;
        }
        .main-table th.text-left { text-align: left; }
        .main-table th.text-center { text-align: center; }

        .main-table td {
            border-bottom: 1px solid #eee; padding: 4px 2px;
            text-align: right; font-size: 8.5px;
        }
        .main-table td.text-left { text-align: left; }
        .main-table td.text-center { text-align: center; }

        /* COLORES Y ESTILOS */
        .col-fiscal { background-color: #f9fbfd; color: #555; }
        .col-neto { background-color: #e3f2fd; color: #000; font-weight: bold; } /* Estilo para la nueva columna */
        .col-total { font-weight: bold; color: #000; background-color: #eef; }
        
        /* UTILIDAD VISIBLE */
        .col-ganancia { 
            background-color: #28a745; 
            color: #ffffff; 
            font-weight: bold; 
            border-bottom: 1px solid #ffffff; 
        }
        
        .col-gasto { color: #dc3545; }
        .negative { color: #dc3545; }

        /* FILA DE TOTALES */
        .totals-row td {
            border-top: 2px solid #333; border-bottom: 2px solid #333;
            font-weight: bold; background-color: #f0f0f0; font-size: 9px;
        }
        /* El total de la ganancia también en verde fuerte */
        .totals-row td.col-ganancia {
            background-color: #218838; 
            color: white;
        }

        /* CUADRO FLUJO */
        .cash-flow-box {
            float: right; width: 300px;
            border: 1px solid #ccc; padding: 10px;
            background-color: #fcfcfc; border-radius: 5px;
            page-break-inside: avoid;
        }
        .cf-row { margin-bottom: 5px; font-size: 10px; }
        .cf-total { 
            margin-top: 5px; border-top: 1px solid #999; padding-top: 5px; 
            font-weight: bold; font-size: 11px;
        }
        .clearfix { clear: both; }
    </style>
</head>
<body>

    <table class="header">
        <tr>
            <td style="width: 10%;">
                <img src="{{ logo_url }}" style="height: 50px;">
            </td>
            <td style="width: 60%;">
                <div class="title">Reporte Detallado de Rentabilidad</div>
                <div class="subtitle">Quinta Ko'ox Tanil | Análisis Fiscal y Financiero</div>
                <div class="subtitle">Generado: {% now "d/m/Y H:i" %}</div>
            </td>
            <td style="width: 30%; text-align: right;">
                <strong>Periodo:</strong> {{ fecha_inicio }} al {{ fecha_fin }}<br>
                <strong>Filtro:</strong> {{ estado_filtro }}
            </td>
        </tr>
    </table>

    <table class="main-table">
        <thead>
            <tr>
                <th class="text-left" style="width: 3%;">ID</th>
                <th class="text-left" style="width: 6%;">Fecha</th>
                <th class="text-left" style="width: 14%;">Cliente</th>
                <th class="text-center" style="width: 6%;">Estado</th>
                
                <th class="col-fiscal" style="width: 7%;">Subtotal</th>
                <th class="col-fiscal" style="width: 6%;">(-) Desc.</th>
                <th class="col-neto" style="width: 7%;">(=) Sub. Neto</th> <th class="col-fiscal" style="width: 6%;">(+) IVA</th>
                <th class="col-fiscal" style="width: 6%;">(-) ISR</th>
                <th class="col-total" style="width: 8%;">= TOTAL</th>
                
                <th style="width: 8%;">Pagado</th>
                <th style="width: 8%; color: #d9534f;">Pendiente</th>
                <th style="width: 7%; color: #d9534f;">Gastos</th>
                <th class="col-ganancia" style="width: 8%;">UTILIDAD</th>
            </tr>
        </thead>
        <tbody>
            {% for item in datos %}
            <tr>
                <td class="text-left">{{ item.folio }}</td>
                <td class="text-left">{{ item.fecha|date:"d/m/y" }}</td>
                <td class="text-left" style="text-transform: uppercase;">{{ item.cliente|truncatechars:18 }}</td>
                <td class="text-center">
                    {% if item.estado == 'Venta Confirmada' %}
                        <span style="color: green;">Conf.</span>
                    {% else %}
                        {{ item.estado }}
                    {% endif %}
                </td>

                <td class="col-fiscal">${{ item.subtotal|floatformat:2|intcomma }}</td>
                
                <td class="col-fiscal negative">
                    {% if item.descuento > 0 %}-{{ item.descuento|floatformat:2|intcomma }}{% else %}-{% endif %}
                </td>

                <td class="col-neto">${{ item.base_real|floatformat:2|intcomma }}</td> <td class="col-fiscal">${{ item.iva|floatformat:2|intcomma }}</td>
                
                <td class="col-fiscal negative">
                    {% if item.isr > 0 %}-{{ item.isr|floatformat:2|intcomma }}{% else %}-{% endif %}
                </td>
                
                <td class="col-total">${{ item.total|floatformat:2|intcomma }}</td>

                <td>${{ item.pagado|floatformat:2|intcomma }}</td>
                <td style="color: #d9534f;">${{ item.pendiente|floatformat:2|intcomma }}</td>
                <td class="col-gasto">${{ item.gastos|floatformat:2|intcomma }}</td>
                <td class="col-ganancia">${{ item.ganancia|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="14" class="text-center" style="padding: 20px;">No hay registros en este periodo.</td>
            </tr>
            {% endfor %}
        </tbody>
        
        <tfoot>
            <tr class="totals-row">
                <td colspan="4" class="text-center">TOTALES DEL PERIODO</td>
                
                <td>${{ t_subtotal|floatformat:2|intcomma }}</td>
                <td class="negative">-${{ t_descuento|floatformat:2|intcomma }}</td>
                <td style="background-color: #dbeeff;">${{ t_base_real|floatformat:2|intcomma }}</td> <td>${{ t_iva|floatformat:2|intcomma }}</td>
                <td class="negative">-${{ t_ret_isr|floatformat:2|intcomma }}</td>
                <td>${{ t_total_ventas|floatformat:2|intcomma }}</td>
                
                <td>${{ t_pagado|floatformat:2|intcomma }}</td>
                <td style="color: #d9534f;">${{ t_pendiente|floatformat:2|intcomma }}</td>
                <td style="color: #d9534f;">${{ t_gastos|floatformat:2|intcomma }}</td>
                <td class="col-ganancia">${{ t_ganancia|floatformat:2|intcomma }}</td>
            </tr>
        </tfoot>
    </table>

    <br>

    <div class="cash-flow-box">
        <h4 style="margin: 0 0 10px 0; color: #356685; border-bottom: 1px solid #eee;">
            Resumen de Flujo de Efectivo (Ingresos Reales)
        </h4>
        
        <div class="cf-row">
            <span style="float:left;">Efectivo Recibido:</span>
            <span style="float:right;">${{ total_efectivo|floatformat:2|intcomma }}</span>
            <div class="clearfix"></div>
        </div>
        
        <div class="cf-row">
            <span style="float:left;">Transferencias / Bancos:</span>
            <span style="float:right;">${{ total_transferencia|floatformat:2|intcomma }}</span>
            <div class="clearfix"></div>
        </div>

        {% if total_otros > 0 %}
        <div class="cf-row">
            <span style="float:left;">Otros Métodos:</span>
            <span style="float:right;">${{ total_otros|floatformat:2|intcomma }}</span>
            <div class="clearfix"></div>
        </div>
        {% endif %}

        <div class="cf-total">
            <span style="float:left;">TOTAL INGRESADO:</span>
            <span style="float:right;">${{ total_ingresado|floatformat:2|intcomma }}</span>
            <div class="clearfix"></div>
        </div>
        <div style="font-size: 8px; color: #999; margin-top: 5px; text-align: center;">
            * Suma de pagos con fecha dentro del filtro seleccionado.
        </div>
    </div>

</body>
</html>