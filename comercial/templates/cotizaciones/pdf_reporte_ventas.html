{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Financiero Fiscal</title>
    <style>
        @page { size: legal landscape; margin: 1cm; }
        body { font-family: 'Helvetica', sans-serif; font-size: 10px; color: #333; }
        
        .header-tbl { width: 100%; border-bottom: 2px solid #333; margin-bottom: 15px; }
        .title { font-size: 18px; font-weight: bold; color: #2c3e50; }
        
        /* TABLA PRINCIPAL */
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .main-table th { 
            background: #2c3e50; color: white; padding: 6px; text-align: right; font-size: 9px; 
            border: 1px solid #1a252f;
        }
        .main-table th.left { text-align: left; }
        .main-table td { padding: 5px; border: 1px solid #ccc; text-align: right; }
        .main-table td.left { text-align: left; }
        
        /* Colores de columnas */
        .bg-venta { background-color: #eafaf1; } 
        .bg-fiscal { background-color: #ebf5fb; } 
        .bg-nofiscal { background-color: #fdfefe; } 
        
        /* RESUMEN FINAL */
        .summary-container { display: flex; gap: 20px; page-break-inside: avoid; }
        .box { width: 48%; border: 1px solid #999; padding: 10px; border-radius: 5px; }
        .box-title { font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 5px; color: #555; }
        .row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .total-row { font-weight: bold; border-top: 1px solid #333; margin-top: 5px; padding-top: 5px; font-size: 12px; }
        
        .text-red { color: #c0392b; }
        .text-green { color: #27ae60; }
        .text-blue { color: #2980b9; }
        
        .sub-header { font-size: 12px; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px; color: #555; }

    </style>
</head>
<body>

    <table class="header-tbl">
        <tr>
            <td>
                {% if logo_url %}<img src="{{ logo_url }}" height="40">{% endif %}
            </td>
            <td style="text-align: right;">
                <div class="title">REPORTE DE RENTABILIDAD Y FISCAL</div>
                <div>{{ fecha_inicio|default:"Inicio" }} al {{ fecha_fin|default:"Hoy" }}</div>
            </td>
        </tr>
    </table>

    <h3 style="margin-bottom: 5px;">1. Desglose por Evento</h3>
    <table class="main-table">
        <thead>
            <tr>
                <th class="left" width="5%">Folio</th>
                <th class="left" width="15%">Cliente</th>
                
                <th width="8%" style="background:#1abc9c;">Venta Total</th>
                <th width="7%" style="background:#16a085;">(-) IVA Tras.</th>
                <th width="8%" style="background:#16a085;">(=) Base Real</th>
                
                <th width="8%" style="background:#3498db;">(-) Gto Fiscal<br>(Base)</th>
                <th width="7%" style="background:#3498db;">(+) IVA Acred.</th>
                
                <th width="8%" style="background:#95a5a6;">(-) Gto No Fiscal<br>(Nota)</th>
                
                <th width="8%" style="background:#2ecc71;">(=) Utilidad</th>
            </tr>
        </thead>
        <tbody>
            {% for d in datos %}
            <tr>
                <td class="left">{{ d.folio }}</td>
                <td class="left">
                    <b>{{ d.cliente|truncatechars:20 }}</b><br>
                    <span style="color:#777; font-size:8px;">{{ d.producto|truncatechars:25 }}</span>
                </td>
                
                <td class="bg-venta"><b>${{ d.venta_total|intcomma }}</b></td>
                <td class="text-red">-${{ d.iva_trasladado|intcomma }}</td>
                <td style="font-weight:bold;">${{ d.base_real_venta|intcomma }}</td>
                
                <td class="bg-fiscal text-red">-${{ d.gasto_fiscal_base|intcomma }}</td>
                <td class="bg-fiscal text-blue">+${{ d.iva_acreditable|intcomma }}</td>
                
                <td class="bg-nofiscal text-red">-${{ d.gasto_nofiscal|intcomma }}</td>
                
                <td style="font-weight:bold; color:green;">${{ d.utilidad|intcomma }}</td>
            </tr>
            {% endfor %}
            
            <tr style="background:#eee; font-weight:bold;">
                <td colspan="2" class="left">TOTAL EVENTOS</td>
                <td>${{ t_venta_total|intcomma }}</td>
                <td class="text-red">-${{ t_iva_trasladado|intcomma }}</td>
                <td>${{ t_base_real|intcomma }}</td>
                
                <td class="text-red">-${{ t_ev_fiscal_base|intcomma }}</td>
                <td class="text-blue">+${{ t_ev_iva|intcomma }}</td>
                
                <td class="text-red">-${{ t_ev_nofiscal|intcomma }}</td>
                
                <td>-</td>
            </tr>
        </tbody>
    </table>

    <br>

    <h3 style="margin-bottom: 5px;">2. Gastos Operativos (Fijos)</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td width="48%" style="vertical-align: top; padding-right: 10px;">
                <div class="sub-header">Gastos Fiscales (Deducibles)</div>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="left">Categoría</th>
                            <th width="20%">Base</th>
                            <th width="20%">IVA</th>
                            <th width="20%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in gastos_operativos_fiscales_list %}
                        <tr>
                            <td class="left">{{ item.nombre }}</td>
                            <td>${{ item.base|floatformat:2|intcomma }}</td>
                            <td class="text-blue">${{ item.iva|floatformat:2|intcomma }}</td>
                            <td>${{ item.total|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr style="background:#eee; font-weight:bold;">
                            <td class="left">SUBTOTAL FISCAL</td>
                            <td class="text-red">-${{ t_op_fiscal_base|intcomma }}</td>
                            <td class="text-blue">+${{ t_op_iva|intcomma }}</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </td>
            
            <td width="48%" style="vertical-align: top; padding-left: 10px;">
                <div class="sub-header">Gastos No Fiscales (Notas)</div>
                <table class="main-table">
                    <thead>
                        <tr>
                            <th class="left">Categoría</th>
                            <th width="30%">Total Pagado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in gastos_operativos_nofiscales_list %}
                        <tr>
                            <td class="left">{{ item.nombre }}</td>
                            <td class="text-red">${{ item.total|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr style="background:#eee; font-weight:bold;">
                            <td class="left">SUBTOTAL NO FISCAL</td>
                            <td class="text-red">-${{ t_op_nofiscal|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </table>

    <br>

    <table style="width:100%;">
        <tr>
            <td width="48%" style="vertical-align: top;">
                <div class="box" style="background:#f9f9f9;">
                    <div class="box-title">RENTABILIDAD REAL DEL NEGOCIO</div>
                    
                    <div class="row">
                        <span>Ingresos Reales (Sin IVA):</span>
                        <span>${{ t_base_real|intcomma }}</span>
                    </div>
                    <div class="row text-red">
                        <span>(-) Costos Fiscales (Base):</span>
                        <span>-${{ total_costos_base|intcomma }}</span>
                    </div>
                    <div class="row text-red">
                        <span>(-) Costos No Fiscales (Notas):</span>
                        <span>-${{ total_costos_nofiscal|intcomma }}</span>
                    </div>
                    
                    <div class="row total-row" style="font-size: 14px;">
                        <span>UTILIDAD NETA:</span>
                        <span class="text-green">${{ utilidad_neta_real|intcomma }}</span>
                    </div>
                </div>
            </td>
            
            <td width="4%"></td>

            <td width="48%" style="vertical-align: top;">
                <div class="box" style="background:#eaf2f8; border-color:#3498db;">
                    <div class="box-title" style="color:#2980b9;">CÁLCULO DE IVA (ESTIMADO)</div>
                    
                    <div class="row">
                        <span>(+) IVA Cobrado (Ventas):</span>
                        <span>${{ t_iva_trasladado|intcomma }}</span>
                    </div>
                    <div class="row text-blue">
                        <span>(-) IVA Acreditable (Eventos):</span>
                        <span>-${{ t_ev_iva|intcomma }}</span>
                    </div>
                    <div class="row text-blue">
                        <span>(-) IVA Acreditable (Operativo):</span>
                        <span>-${{ t_op_iva|intcomma }}</span>
                    </div>
                    
                    <div class="row total-row" style="font-size: 14px;">
                        <span>IVA POR PAGAR:</span>
                        <span style="color:#c0392b;">${{ iva_por_pagar|intcomma }}</span>
                    </div>
                    <div style="font-size:8px; color:#777; margin-top:5px; text-align:center;">
                        * Solo considera facturas con UUID válido. Las notas no deducen IVA.
                    </div>
                </div>
            </td>
        </tr>
    </table>

</body>
</html>